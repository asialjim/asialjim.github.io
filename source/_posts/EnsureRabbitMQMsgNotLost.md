---
title: RabbitMQ保证消息不丢失
author: AsialJim
categories:
  - 中间件
  - MQ
archives:
  - MQ
  - 中间件
tags:
  - MQ
abbrlink: 26042
date: 2024-07-26 14:17:33
---
## 消息队列
### 消息队列模式
    当前，RabbitMQ主要分为两种模式，点对点模式和发布订阅模式
#### 点对点模式
    所谓点对点模式，即：一个具体的消息（生产者）只能由一个消费者进行消费
    当一条消息正在被一个消费者消费时，其他消费者不能消费该消息
#### 发布订阅模式
    所谓发布订阅模式，即：会有多个消费者按照某个规则订阅某一类消息。
    而这个规则，一般来讲就是MQ的所谓 Toic 和 Tag
    消费者可根据Topic 来消费消息。
    需要注意的时，发布订阅模式下， 一条消息将可以被多个消费者消费。

# RabbitMQ 架构
    由于RabbitMQ遵循AMQP协议，故此，RabbitMQ中也存在如下概念：
    1. Server: 实现 AMQP 服务
    2. Connection: 连接， 应用程序（生产者、消费者）与Server 的网络TCP链接
    3. Channel: 信道，应用程序与Server链接中建立的多个通道。每个通道表示一个会话任务。
    4. Message: 消息，即应用程序与服务器之间传送的数据。
    5. VirtualHost: 虚拟主机，用于隔离交换机和队列。
    6. Exchange：交换机，接受消息，并按照路由规则将消息按照规则路由到消息队列。
    7. Binding： 绑定，交换机和消息队列之间的虚拟链接
    8. RoutingKey: 路由键，生产者将消息发送给交换机时用来指定路由规则。
    9. Queue： 消息队列，用来保存消息，共消费者消费。
## 工作原理图
![图片](/medias/images/d61b59e862e50af860ae615b9ffb9dde.png)
### 常用交换机
    RabbitMQ常用交换机类型有：Direct, Topic, Fanout, Headers
#### Direct 交换机
    见名知意，交换机需要绑定一个队列，要求该消息与一个特定的路由键完全匹配
#### Fanout 交换机
    交换机绑定到消息队列上，当一个发送到交换机的消息会被转发到与该消息绑定的所有队列，类似广播消息。
#### Topic 交换机
    交换机通过消息的某种规则（通配符），将消息路由到对应的队列中。
#### Header 交换机
    与上面三种交换机不同，其消息路由方案是根据消息的请求头，路由到对应的规则

## 消费原理
#### 概念
    1. Broker  MQ 服务器运行实例，用于维护该节点的队列的正山以及转发队列操作要求
    2. Master Queue:  每个队列有主队列和镜像队列。
    3. Mirror Queue:  镜像队列。作为 主队列的备份。
#### 原理
    1. 消费者连接到Broker中，并按照指定规则订阅消息队列
    2. 主队列与镜像队列通过消息同步机制，保持数据一致。

消费原理图
![图片](/medias/images/fe9817a835947c4c1ec9d04ee2e492ad.png)
## 高级特性
#### 过期时间
    消息的生存时间，指一条消息在队列中存活的最大时间，单位毫秒。
    根据此特性，消息发送时，可设置消息的过期时间。
#### 消息确认
    为了保证消息从队列可靠地到达消费者，提供确认机制。
    消费者订阅队列后，可以指定 ack参数。 RabbitMQ自动把发送的消息设置为确认。然后从内存或者硬盘中删除。
    而当指定消费者必须手动确认时，只有RabbitMQ 收到确认信号后，才会删除删除消息。
此机制，可以保证消息的投递可靠性。

## 持久化
成熟的消息队列，一定需要确保消息的可靠性，不会因为异常情况下丢失数据。
RabbitMQ 持久化分三部分

    交换器持久化，可保证RabbitMQ服务器重启后，交换器元数据不会丢失，且消息依旧能够发送到此交换器
    队列持久化，保证本身的元数据不会因异常情况丢失。但是不能保证内部存储的消息不会丢失
    消息持久化，服务重启后，消息不会丢失。

## 死信队列
    所谓死信，表示消息被拒绝、消息过期或者队列到达最大长度时，消息无法正常投递到消费者。
    当消息在队列中变为死信后，将消息发送到死信队列，该队列专用于处理死信。
    死信队列一般用于分析消息异常、改进优化系统。

## 延迟队列
    所谓延迟队列，见名知意表示当消息从生产者发送到服务器后，消费者不会立即消费到该队列。
    根据消息指定的特定时间后，消费者才会消费到队列。

# 如何保证消息不丢失。
    根据以上信息，我们可以最大可能设计一套系统，保证消息不被丢失掉。

## 设计方案
    1. 服务器配置开启交换机、队列和消息持久化。
    2. 开启消息确认机制，确保消息成功投递。
    3. 发送消息前，将消息持久化到数据库。 
    4. 发送消息时，当服务器明确收到消息后，将该消息在数据库标记为已发送
    5. 消费消息时，消费者将消息从数据库标记为已消费。
    6. 理论上，没有完全可靠的消息不丢失机制，需用户根据系统实际情况进行综合考虑